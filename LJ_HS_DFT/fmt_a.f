	SUBROUTINE DFEXR(I,IR,DPE,DDR,DFR)
!  THIS SUBROUTINE IS TO CALCULATE THE LOCAL EXCESS CHEMICAL POTENTIAL DUE TO REPULSION

	IMPLICIT NONE
      REAL*8 RHOB,DC,DP,T,MIX_F,RB,RC,DR,TOLE,PI
      COMMON RHOB,DC,DP,T,MIX_F,RB,RC,DR,TOLE,PI
      INTEGER NP,I,J,K, IW,IR
      PARAMETER(NP=2**13)

	REAL*8 DPE
      REAL*8 DDR(3,NP),DDR1,DDR2,DDR3
	REAL*8 DFR1,DFR2,DFR3,DFR

	REAL*8 R,R1,X1,X2,X
	REAL*8 RIN,RIP,DR1,DR2
	INTEGER KIN,KIP

	IW=I-IR+1  !INDEX IN THE WEIGHTED DENSITY FUNCTIONS
	R=DC/2+FLOAT(I-1)*DR

	RIN=R-DPE/2.0	! INTEGRATION LIMITS
	RIP=R+DPE/2.0

      KIN=NINT((RIN-DC/2)/DR)+1
      KIP=NINT((RIP-DC/2)/DR)+1

	DR1=RIN-DC/2-FLOAT(KIN-1)*DR
	DR2=RIP-DC/2-FLOAT(KIP-1)*DR

	DFR1=0.0
	DFR2=0.0
	DFR3=0.0

	DO 10 K=KIN,KIP
	J=K-IR+1  !POSITION INDEX IN THE DENSITY PROFILE
	R1=DC/2+FLOAT(K-1)*DR

	IF(R1.GE.DC/2.0) THEN

	IF (K.EQ.KIN) THEN
! LINEAR INTERPOLATION AT THE BOUNDARY POINTS
	X1=DDR(1,J)*R1
	X2=DDR(1,J+1)*(R1+DR)
	X=X1+(X2-X1)*DR1/DR
	DDR1=(X1+X)*DR1/2.0

	X1=DDR(1,J)*R1*(DPE**2/4.-(R-R1)**2)
	X2=DDR(1,J+1)*(R1+DR)*(DPE**2/4.-(R-R1-DR)**2)
	X=X1+(X2-X1)*DR1/DR
	DDR2=(X1+X)*DR1/2.0

	X1=DDR(1,J)*(DPE**2/4.-R**2+R1**2)
	X2=DDR(1,J+1)*(DPE**2/4.-R**2+(R1+DR)**2)
	X=X1+(X2-X1)*DR1/DR
	DDR3=(X1+X)*DR1/2.0

	DFR1=DFR1-DDR1+DDR(1,J)*R1*DR/2.0
	DFR2=DFR2-DDR2+DDR(2,J)*R1*DR*(DPE**2/4.-(R-R1)**2)/2.0
	DFR3=DFR3-DDR3+DDR(3,J)*DR*(DPE**2/4.-R**2+R1**2)/2.0

	ELSEIF (K.EQ.KIP) THEN
	X1=DDR(1,J)*R1
	X2=DDR(1,J+1)*(R1+DR)
	X=X1+(X2-X1)*DR2/DR
	DDR1=(X1+X)*DR2/2.0

	X1=DDR(1,J)*R1*(DPE**2/4.-(R-R1)**2)
	X2=DDR(1,J+1)*(R1+DR)*(DPE**2/4.-(R-R1-DR)**2)
	X=X1+(X2-X1)*DR2/DR
	DDR2=(X1+X)*DR2/2.0

	X1=DDR(1,J)*(DPE**2/4.-R**2+R1**2)
	X2=DDR(1,J+1)*(DPE**2/4.-R**2+(R1+DR)**2)
	X=X1+(X2-X1)*DR2/DR
	DDR3=(X1+X)*DR2/2.0

	DFR1=DFR1+DDR1+DDR(1,J)*R1*DR/2.0
	DFR2=DFR2+DDR2+DDR(2,J)*R1*DR*(DPE**2/4.-(R-R1)**2)/2.0
	DFR3=DFR3+DDR3+DDR(3,J)*DR*(DPE**2/4.-R**2+R1**2)/2.0

	ELSE
	DFR1=DFR1+DDR(1,J)*R1*DR
	DFR2=DFR2+DDR(2,J)*R1*DR*(DPE**2/4.-(R-R1)**2)
	DFR3=DFR3+DDR(3,J)*DR*(DPE**2/4.-R**2+R1**2)
	ENDIF

	ENDIF

10    CONTINUE
	 
	DFR1=DFR1*PI*DPE/R
	DFR2=DFR2*PI/R
	DFR3=DFR3*PI/R

	DFR=DFR1+DFR2+DFR3

	RETURN
	END

